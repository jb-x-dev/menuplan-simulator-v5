<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beschaffungsaufl√∂sung - Men√ºplansimulator</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: white;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        .nav-home {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .nav-home a {
            display: inline-block;
            padding: 10px 20px;
            background: white;
            border: 2px solid #D3D3D3;
            color: #4A4A4A;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .nav-home a:hover {
            border-color: #87CEEB;
            color: #87CEEB;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            color: #4A4A4A;
        }
        
        .section {
            background: white;
            border: 2px solid #D3D3D3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            margin-top: 0;
            color: #4A4A4A;
            border-bottom: 2px solid #D3D3D3;
            padding-bottom: 10px;
        }
        
        .menu-plan-card {
            background: white;
            border: 2px solid #D3D3D3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .menu-plan-card:hover {
            border-color: #87CEEB;
        }
        
        .menu-plan-card.selected {
            border-color: #87CEEB;
            background: #F0F8FF;
        }
        
        .day-section {
            margin: 15px 0;
            padding: 15px;
            background: #F8F9FA;
            border: 2px solid #D3D3D3;
            border-radius: 6px;
        }
        
        .day-header {
            font-weight: 600;
            font-size: 16px;
            color: #4A4A4A;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .recipe-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: white;
            border: 1px solid #D3D3D3;
            border-radius: 4px;
        }
        
        .recipe-name {
            flex: 1;
            font-weight: 500;
            color: #4A4A4A;
        }
        
        .recipe-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .info-btn {
            padding: 5px 10px;
            background: white;
            border: 2px solid #D3D3D3;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .info-btn:hover {
            border-color: #87CEEB;
            color: #87CEEB;
        }
        
        .summary-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 15px;
            border: 2px solid #D3D3D3;
            border-radius: 6px;
            text-align: center;
        }
        
        .summary-label {
            font-size: 12px;
            color: #808080;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 20px;
            font-weight: 600;
            color: #4A4A4A;
        }
        
        .component-day {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border: 2px solid #D3D3D3;
            border-radius: 6px;
        }
        
        .component-day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .component-day-title {
            font-weight: 600;
            font-size: 16px;
            color: #4A4A4A;
        }
        
        .day-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .component-list {
            margin-top: 10px;
        }
        
        .component-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 3px 0;
            background: #F8F9FA;
            border-radius: 4px;
        }
        
        .btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #D3D3D3;
            color: #4A4A4A;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            border-color: #87CEEB;
            color: #87CEEB;
        }
        
        .btn-primary {
            background: #87CEEB;
            color: white;
            border-color: #87CEEB;
        }
        
        .btn-primary:hover {
            background: #6BB6D9;
            border-color: #6BB6D9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            max-width: 800px;
            border-radius: 8px;
            border: 2px solid #D3D3D3;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #D3D3D3;
            padding-bottom: 15px;
        }
        
        .close-btn {
            font-size: 28px;
            font-weight: bold;
            color: #808080;
            cursor: pointer;
        }
        
        .close-btn:hover {
            color: #4A4A4A;
        }
        
        .order-preview {
            background: #F8F9FA;
            padding: 20px;
            border: 2px solid #D3D3D3;
            border-radius: 6px;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #D3D3D3;
        }
        
        th {
            background: #F8F9FA;
            font-weight: 600;
            color: #4A4A4A;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #808080;
        }
    </style>
</head>
<body>
    <div class="nav-home">
        <a href="landing.html">üè† Startseite</a>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üì¶ Beschaffungsaufl√∂sung</h1>
        </div>
        
        <!-- Men√ºplan-Auswahl -->
        <div class="section">
            <h2>1. Men√ºplan ausw√§hlen</h2>
            <div id="menuPlansList">
                <div class="loading">Lade aktive Men√ºpl√§ne...</div>
            </div>
        </div>
        
        <!-- Rezept-√úbersicht -->
        <div class="section" id="recipeOverview" style="display: none;">
            <h2>2. Rezept-√úbersicht</h2>
            <div id="recipeDetails"></div>
            <div class="summary-box" id="totalSummary"></div>
        </div>
        
        <!-- Komponenten nach Bedarfstag -->
        <div class="section" id="componentSection" style="display: none;">
            <h2>3. Komponenten nach Bedarfstag</h2>
            <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="selectAllDays" class="day-checkbox">
                    <span style="font-weight: 600;">Alle Tage ausw√§hlen</span>
                </label>
            </div>
            <div id="componentsByDay"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-primary" onclick="generateOrderProposal()">üìã Bestellvorschlag erzeugen</button>
            </div>
        </div>
        
        <!-- Bestellvorschlag Modal -->
        <div id="orderModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">üìã Bestellvorschlag</h2>
                    <span class="close-btn" onclick="closeOrderModal()">&times;</span>
                </div>
                <div id="orderPreview"></div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn" onclick="closeOrderModal()">Abbrechen</button>
                    <button class="btn btn-primary" onclick="sendToJBX()">An jb-x √ºbergeben</button>
                </div>
            </div>
        </div>
        
        <!-- Rezept-Details Modal -->
        <div id="recipeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;" id="recipeModalTitle">Rezept-Details</h2>
                    <span class="close-btn" onclick="closeRecipeModal()">&times;</span>
                </div>
                <div id="recipeModalContent"></div>
            </div>
        </div>
    </div>
    
    <script>
        let menuPlans = [];
        let selectedPlan = null;
        let allRecipes = [];
        let componentsByDay = {};
        
        // Lade Men√ºpl√§ne beim Start
        document.addEventListener('DOMContentLoaded', function() {
            loadMenuPlans();
            loadAllRecipes();
        });
        
        async function loadMenuPlans() {
            try {
                const response = await fetch('/api/menu-plans?status=Aktiv');
                const data = await response.json();
                menuPlans = data.plans || [];
                displayMenuPlans();
            } catch (error) {
                console.error('Fehler beim Laden der Men√ºpl√§ne:', error);
                document.getElementById('menuPlansList').innerHTML = '<p style="color: #dc3545;">Fehler beim Laden der Men√ºpl√§ne</p>';
            }
        }
        
        async function loadAllRecipes() {
            try {
                const response = await fetch('/api/recipes');
                const data = await response.json();
                allRecipes = data.recipes || data || [];
            } catch (error) {
                console.error('Fehler beim Laden der Rezepte:', error);
            }
        }
        
        function displayMenuPlans() {
            const container = document.getElementById('menuPlansList');
            
            if (menuPlans.length === 0) {
                container.innerHTML = '<p style="color: #808080;">Keine aktiven Men√ºpl√§ne vorhanden. Erstellen Sie einen Men√ºplan im Men√ºplansimulator und setzen Sie den Status auf "Aktiv".</p>';
                return;
            }
            
            container.innerHTML = '';
            menuPlans.forEach((plan, index) => {
                const card = createMenuPlanCard(plan, index);
                container.appendChild(card);
            });
        }
        
        function createMenuPlanCard(plan, index) {
            const card = document.createElement('div');
            card.className = 'menu-plan-card';
            card.onclick = () => selectMenuPlan(index);
            
            const totalRecipes = plan.plan?.days?.reduce((sum, day) => {
                return sum + (day.menu_lines?.length || day.meals?.length || 0);
            }, 0) || 0;
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 600; font-size: 18px; color: #4A4A4A;">${plan.name}</div>
                        <div style="color: #808080; margin-top: 5px;">
                            ${plan.plan?.days?.length || 0} Tage ‚Ä¢ ${totalRecipes} Rezepte
                        </div>
                    </div>
                    <div style="color: #87CEEB; font-size: 24px;">‚Üí</div>
                </div>
            `;
            
            return card;
        }
        
        function selectMenuPlan(index) {
            selectedPlan = menuPlans[index];
            
            // Update UI
            document.querySelectorAll('.menu-plan-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            // Zeige Rezept-√úbersicht
            displayRecipeOverview();
            
            // Berechne Komponenten
            calculateComponents();
        }
        
        function displayRecipeOverview() {
            const section = document.getElementById('recipeOverview');
            const details = document.getElementById('recipeDetails');
            const summary = document.getElementById('totalSummary');
            
            section.style.display = 'block';
            details.innerHTML = '';
            
            const plan = selectedPlan.plan;
            const days = plan.days || [];
            
            let totalPortions = 0;
            let totalCost = 0;
            let totalDays = days.length;
            
            days.forEach((day, dayIdx) => {
                const daySection = document.createElement('div');
                daySection.className = 'day-section';
                
                const recipes = day.menu_lines || day.meals || [];
                let dayPortions = 0;
                let dayCost = 0;
                
                let recipesHTML = '';
                recipes.forEach(recipe => {
                    const portions = recipe.quantity || recipe.portions || 0;
                    const cost = (recipe.cost_per_serving || 0) * portions;
                    
                    dayPortions += portions;
                    dayCost += cost;
                    
                    recipesHTML += `
                        <div class="recipe-item">
                            <div class="recipe-name">${recipe.name || recipe.recipe_name}</div>
                            <div class="recipe-info">
                                <span>${portions} Portionen</span>
                                <span>${cost.toFixed(2)} ‚Ç¨</span>
                                <button class="info-btn" onclick="showRecipeInfo('${recipe.recipe_id || recipe.id}')">‚ÑπÔ∏è Info</button>
                            </div>
                        </div>
                    `;
                });
                
                totalPortions += dayPortions;
                totalCost += dayCost;
                
                const dayBKT = dayPortions > 0 ? (dayCost / dayPortions).toFixed(2) : '0.00';
                
                daySection.innerHTML = `
                    <div class="day-header">
                        <span>Tag ${dayIdx + 1} (${day.date || ''})</span>
                        <span>${dayPortions} Portionen ‚Ä¢ ${dayCost.toFixed(2)} ‚Ç¨ ‚Ä¢ BKT: ${dayBKT} ‚Ç¨</span>
                    </div>
                    ${recipesHTML}
                `;
                
                details.appendChild(daySection);
            });
            
            const totalBKT = totalPortions > 0 ? (totalCost / totalPortions).toFixed(2) : '0.00';
            
            summary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Gesamtportionen</div>
                    <div class="summary-value">${totalPortions}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Gesamtkosten</div>
                    <div class="summary-value">${totalCost.toFixed(2)} ‚Ç¨</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Gesamt-BKT</div>
                    <div class="summary-value">${totalBKT} ‚Ç¨</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Tage</div>
                    <div class="summary-value">${totalDays}</div>
                </div>
            `;
        }
        
        async function calculateComponents() {
            const section = document.getElementById('componentSection');
            const container = document.getElementById('componentsByDay');
            
            section.style.display = 'block';
            container.innerHTML = '<div class="loading">Berechne Komponenten...</div>';
            
            try {
                const response = await fetch('/api/procurement/from-plans', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_ids: [selectedPlan.id || selectedPlan.name]
                    })
                });
                
                const data = await response.json();
                componentsByDay = data.components_by_day || {};
                
                displayComponentsByDay();
            } catch (error) {
                console.error('Fehler beim Berechnen der Komponenten:', error);
                container.innerHTML = '<p style="color: #dc3545;">Fehler beim Berechnen der Komponenten</p>';
            }
        }
        
        function displayComponentsByDay() {
            const container = document.getElementById('componentsByDay');
            container.innerHTML = '';
            
            const days = Object.keys(componentsByDay).sort();
            
            if (days.length === 0) {
                container.innerHTML = '<p style="color: #808080;">Keine Komponenten gefunden</p>';
                return;
            }
            
            days.forEach(day => {
                const components = componentsByDay[day];
                const dayDiv = document.createElement('div');
                dayDiv.className = 'component-day';
                
                let componentsHTML = '';
                components.forEach(comp => {
                    componentsHTML += `
                        <div class="component-item">
                            <span>${comp.name}</span>
                            <span>${comp.quantity.toFixed(2)} ${comp.unit}</span>
                        </div>
                    `;
                });
                
                dayDiv.innerHTML = `
                    <div class="component-day-header">
                        <div class="component-day-title">Bedarfstag: ${day}</div>
                        <label>
                            <input type="checkbox" class="day-checkbox" data-day="${day}">
                            <span style="margin-left: 5px;">Ausw√§hlen</span>
                        </label>
                    </div>
                    <div class="component-list">
                        ${componentsHTML}
                    </div>
                `;
                
                container.appendChild(dayDiv);
            });
            
            // "Alle ausw√§hlen" Funktionalit√§t
            document.getElementById('selectAllDays').onchange = function() {
                document.querySelectorAll('.day-checkbox[data-day]').forEach(cb => {
                    cb.checked = this.checked;
                });
            };
        }
        
        function generateOrderProposal() {
            const selectedDays = [];
            document.querySelectorAll('.day-checkbox[data-day]:checked').forEach(cb => {
                selectedDays.push(cb.dataset.day);
            });
            
            if (selectedDays.length === 0) {
                alert('Bitte w√§hlen Sie mindestens einen Tag aus');
                return;
            }
            
            // Sammle Komponenten f√ºr ausgew√§hlte Tage
            const orderComponents = {};
            selectedDays.forEach(day => {
                const components = componentsByDay[day];
                components.forEach(comp => {
                    if (!orderComponents[comp.name]) {
                        orderComponents[comp.name] = {
                            name: comp.name,
                            unit: comp.unit,
                            quantity: 0,
                            days: []
                        };
                    }
                    orderComponents[comp.name].quantity += comp.quantity;
                    orderComponents[comp.name].days.push(day);
                });
            });
            
            displayOrderProposal(orderComponents, selectedDays);
        }
        
        function displayOrderProposal(components, days) {
            const preview = document.getElementById('orderPreview');
            
            let tableHTML = `
                <h3>Ausgew√§hlte Tage: ${days.join(', ')}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Komponente</th>
                            <th>Menge</th>
                            <th>Einheit</th>
                            <th>Bedarfstage</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.values(components).forEach(comp => {
                tableHTML += `
                    <tr>
                        <td>${comp.name}</td>
                        <td>${comp.quantity.toFixed(2)}</td>
                        <td>${comp.unit}</td>
                        <td>${comp.days.join(', ')}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            preview.innerHTML = tableHTML;
            document.getElementById('orderModal').style.display = 'block';
        }
        
        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        async function sendToJBX() {
            alert('Funktion "An jb-x √ºbergeben" wird implementiert.\n\nDer Bestellvorschlag w√ºrde jetzt an die jb-x eBusiness Suite √ºbertragen.');
            closeOrderModal();
        }
        
        async function showRecipeInfo(recipeId) {
            try {
                // Konvertiere zu Number falls String
                const numId = parseInt(recipeId);
                
                // Lade Rezeptdaten von API
                const response = await fetch(`/api/recipe/${numId}`);
                if (!response.ok) {
                    throw new Error('Rezept nicht gefunden');
                }
                
                const data = await response.json();
                const recipe = data.recipe;
                
                if (!recipe) {
                    alert('Rezept nicht gefunden');
                    return;
                }
                
                const modal = document.getElementById('recipeModal');
                const title = document.getElementById('recipeModalTitle');
                const content = document.getElementById('recipeModalContent');
                
                title.textContent = recipe.name || recipe.recipe_name;
                
                content.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Beschreibung:</strong><br>
                        ${recipe.description || 'Keine Beschreibung verf√ºgbar'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Kosten pro Portion:</strong> ${(recipe.cost || 0).toFixed(2)} ‚Ç¨
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Kategorie:</strong> ${recipe.category || 'Keine Angabe'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Allergene:</strong><br>
                        ${recipe.allergens?.join(', ') || 'Keine Angabe'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Zusatzstoffe:</strong><br>
                        ${recipe.additives?.join(', ') || 'Keine Angabe'}
                    </div>
                    <div style="margin-bottom: 15px;">
                        <strong>Ern√§hrungsformen:</strong><br>
                        ${recipe.dietary_forms?.join(', ') || 'Keine Angabe'}
                    </div>
                    ${recipe.ingredients && recipe.ingredients.length > 0 ? `
                    <div>
                        <strong>Zutaten (Basis: ${recipe.calculation_basis || 1} Portionen):</strong>
                        <ul style="margin-top: 10px;">
                            ${recipe.ingredients.map(ing => `<li>${ing.name}: ${ing.quantity} ${ing.unit}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Fehler beim Laden der Rezeptdaten:', error);
                alert('Fehler beim Laden der Rezeptdaten: ' + error.message);
            }
        }
        
        function closeRecipeModal() {
            document.getElementById('recipeModal').style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const orderModal = document.getElementById('orderModal');
            const recipeModal = document.getElementById('recipeModal');
            
            if (event.target === orderModal) {
                closeOrderModal();
            }
            if (event.target === recipeModal) {
                closeRecipeModal();
            }
        };
    </script>
</body>
</html>

